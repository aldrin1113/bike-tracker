<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Triumph Street 765 S</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      color: #fff;
      background: url('https://cdn.pixabay.com/photo/2020/09/15/14/50/motorcycle-5573495_1280.jpg') no-repeat center center fixed;
      background-size: cover;
    }

    .container {
      backdrop-filter: blur(6px);
      background-color: rgba(0, 0, 0, 0.4);
      padding: 10px;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .title {
      text-align: center;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .gauges {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    canvas {
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
    }

    .buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 20px auto;
      max-width: 200px;
    }

    button {
      padding: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background-color: #1e90ff;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #005cbf;
    }

    .info {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">Street Triple 765S Ride Logger</div>

    <div class="gauges">
      <canvas id="speedometer" width="180" height="180"></canvas>
      <canvas id="leanGauge" width="180" height="180"></canvas>
    </div>

    <div class="buttons">
      <button onclick="startLogging()">Start Logging</button>
      <button onclick="stopLogging()">Stop Logging</button>
      <button onclick="clearLog()">Clear Log</button>
      <button onclick="downloadLog()">Download Log</button>
      <button onclick="calibrateLean()">Calibrate Lean</button>
    </div>

    <div class="info" id="status">Waiting for sensor data...</div>
  </div>

  <script>
    const speedCanvas = document.getElementById("speedometer");
    const leanCanvas = document.getElementById("leanGauge");
    const speedCtx = speedCanvas.getContext("2d");
    const leanCtx = leanCanvas.getContext("2d");

    let log = [];
    let logging = false;
    let leanOffset = 0;
    let logInterval;

    let currentSpeed = 0;
    let currentLean = 0;

    function drawSpeedometer(speed) {
      speedCtx.clearRect(0, 0, 180, 180);
      const maxSpeed = 100;
      const barHeight = (speed / maxSpeed) * 150;

      speedCtx.fillStyle = "#1e90ff";
      speedCtx.fillRect(80, 180 - barHeight, 20, barHeight);

      speedCtx.font = "20px Arial";
      speedCtx.fillStyle = "white";
      speedCtx.fillText(`${Math.round(speed)} km/h`, 40, 20);
    }

    function drawLeanGauge(lean) {
      leanCtx.clearRect(0, 0, 180, 180);
      const radius = 70;
      const centerX = 90;
      const centerY = 150;

      leanCtx.beginPath();
      leanCtx.arc(centerX, centerY, radius, Math.PI, 2 * Math.PI);
      leanCtx.lineWidth = 8;
      leanCtx.strokeStyle = "#ccc";
      leanCtx.stroke();

      const angleRad = Math.PI + (lean / 90) * Math.PI;

      leanCtx.beginPath();
      leanCtx.moveTo(centerX, centerY);
      leanCtx.lineTo(centerX + radius * Math.cos(angleRad), centerY + radius * Math.sin(angleRad));
      leanCtx.strokeStyle = "red";
      leanCtx.lineWidth = 6;
      leanCtx.stroke();
    }

    function calibrateLean() {
      leanOffset = currentLean;
      document.getElementById("status").innerText = "Lean angle calibrated.";
    }

    function startLogging() {
      if (!logging) {
        logging = true;
        document.getElementById("status").innerText = "Logging started.";
        logInterval = setInterval(() => {
          const now = new Date().toLocaleTimeString();
          const grip = calculateGrip(currentSpeed, currentLean);
          log.push(`${now};${Math.round(currentSpeed)};${getLeanDirection(currentLean)};${grip}`);
        }, 3000);
      }
    }

    function stopLogging() {
      logging = false;
      clearInterval(logInterval);
      document.getElementById("status").innerText = "Logging stopped.";
    }

    function clearLog() {
      log = [];
      document.getElementById("status").innerText = "Log cleared.";
    }

    function downloadLog() {
      const blob = new Blob([log.join("\n")], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ride_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    function getLeanDirection(deg) {
      return deg > 5 ? "Right" : deg < -5 ? "Left" : "Straight";
    }

    function calculateGrip(speed, lean) {
      const maxGrip = 100;
      const grip = maxGrip - (Math.abs(lean) / 90) * 50 - (speed / 100) * 30;
      return Math.max(0, grip.toFixed(1));
    }

    window.addEventListener("devicemotion", (event) => {
      const y = event.accelerationIncludingGravity.y || 0;
      const z = event.accelerationIncludingGravity.z || 1;

      const speedRaw = Math.abs(y) * 5;
      currentSpeed = currentSpeed * 0.8 + speedRaw * 0.2; // moderate smoothing
      drawSpeedometer(currentSpeed);

      currentLean = Math.atan2(y, z) * (180 / Math.PI) - leanOffset;
      drawLeanGauge(currentLean);
    });
  </script>
</body>
</html>
